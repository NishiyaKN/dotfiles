import vapoursynth as vs
from vapoursynth import core

clip = video_in

# --- SAFETY BLOCK ---
src_fps = 23.976
if 'container_fps' in globals() and container_fps > 0.1:
    src_fps = container_fps

clip = core.std.AssumeFPS(clip, fpsnum=int(src_fps * 1000), fpsden=1000)

if clip.format.id != vs.YUV420P8:
    clip = core.resize.Point(clip, format=vs.YUV420P8)

dst_fps = 50

if clip.width > 1920 or clip.height > 1080 or src_fps > 59:
    clip.set_output()
else:
    # 1. LOWER PRECISION (Speed Fix)
    # pel=2 is much faster than pel=4. 
    # It solves the lag immediately.
    super_ = core.mv.Super(clip, pel=2, hpad=16, vpad=16) 
    
    # 2. STANDARD ANALYSIS (No DCT)
    # We removed 'dct=1'. We kept blksize=16 to keep the face stable.
    bvec = core.mv.Analyse(super_, blksize=16, isb=True, chroma=True, search=4, overlap=8)
    fvec = core.mv.Analyse(super_, blksize=16, isb=False, chroma=True, search=4, overlap=8)

    # 3. Interpolate
    clip = core.mv.FlowFPS(
        clip, super_, bvec, fvec, 
        num=int(dst_fps * 1000), den=1000, 
        mask=1, 
        thscd1=60, thscd2=70
    )

    clip.set_output()
